# DnD Tabletop (MVP)

Веб-приложение «стол» для DnD: генерация карт, токены, туман войны и синхронная игра Master/Players в браузере.

## Стек
- Клиент: TypeScript + PixiJS v8 + Vite
- Сервер: Node.js + ws (WebSocket)
- Общие типы/протокол: пакет `@dnd/shared`

Требования: Node.js >= 18, npm >= 9.

## Возможности
- Реалтайм синхронизация: перемещение токенов, обновления характеристик, изменения карты видны всем.
- Туман войны: авто‑открытие по радиусу зрения только для игровых токенов (не для NPC); ручное открытие/скрытие для DM.
- Многоуровневые карты: уровни с seed‑генерацией пола/стен/объектов, спавн‑точка.
- Пол/почва и редактор: кисти 1–4 клетки, рисование/стирание пола и объектов.
- Объекты/ассеты: стены, двери (кликабельные, открываются/закрываются), окна, кусты, сундуки и т. п.; перетаскивание ассетов (DM).
- Двери влияют на линию видимости/проходимость (закрытая дверь — как стена).
- Панорама и масштаб: перетаскивание фона, зум колесом под курсором; мини‑карта.
- Токены: перетаскивание по сетке; роли DM/Player и права; редактирование имени, HP/AC, статов, цвета, радиуса/угла зрения.
- Локации (JSON): дерево папок, список, загрузка, сохранение, перемещение, удаление, переименование папок; «Недавние».

## Структура репозитория
```
.
├─ packages/
│  ├─ client/           # Vite + PixiJS клиент
│  │  ├─ index.html
│  │  └─ src/
│  │     └─ main.ts    # подключение к WS, рендер сетки и токенов
│  ├─ server/           # Node + ws сервер-авторитет
│  │  └─ src/
│  │     └─ index.ts   # WS /ws, события, snapshot, базовые права
│  └─ shared/           # Общие типы и протокол сообщений
│     └─ src/
│        ├─ types.ts
│        └─ protocol.ts
├─ package.json          # npm workspaces, общие скрипты
├─ tsconfig.base.json    # базовые TS-настройки и алиасы
└─ .gitignore
```

## Быстрый старт (Dev)
1) Установка зависимостей в корне:
```
npm install
```
2) Запуск клиента и сервера параллельно:
```
npm run dev
```
3) Открыть клиент:
- http://localhost:5173/?inv=dm-local — зайти как DM (Мастер)
- http://localhost:5173/?inv=pl-local — зайти как Player (Игрок)

Сервер доступен по ws://localhost:8080/ws (HTTP проверка: http://localhost:8080/ возвращает 200).

- Контролы: перетаскивайте токены мышью (привязка к сетке). Фон — панорамирование ЛКМ по пустому месту; масштаб колесом с фокусом под курсором. Двери кликабельны (DM и игроки в режиме курсора).

## Скрипты
- `npm run dev` — старт серверной и клиентской частей одновременно
- `npm run server:dev` — только сервер (watch)
- `npm run client:dev` — только клиент (Vite)
- `npm run build` — сборка всех пакетов
- `npm start` — запуск продакшн‑сборок: сервер (`node dist/index.js`) + клиент (Vite preview)
- `npm run server:start` — только сервер из сборки (`packages/server/dist/index.js`)
- `npm run client:preview` — предпросмотр собранного клиента (по умолчанию :5173)

## Продакшн запуск
1) Собрать все пакеты:
```
npm run build
```
2) Запустить сервер и предпросмотр клиента параллельно:
```
npm start
```
По умолчанию:
- Сервер: http://localhost:8080 (WS: ws://localhost:8080/ws)
- Клиент (preview): http://localhost:5173
Можно открыть клиент как DM/Player: `http://localhost:5173/?inv=dm-local` или `?inv=pl-local`.

## Протокол (черновик)
- Client → Server:
  - `{ t: "join", name?, invite? }`
  - `{ t: "moveToken", tokenId, pos:{x,y}, levelId }`
- Server → Client:
  - `{ t: "welcome", playerId, role, snapshot }`
  - `{ t: "statePatch", events: [...] }`
  - `{ t: "error", message }`

События (часть):
- `tokenSpawned { token }`
- `tokenMoved { tokenId, pos, levelId }`

## MVP-план ближайших итераций
- Генерация пола/стен/объектов (чанки 32×32, seed‑детерминированно)
- Туман войны (глобальная маска, авто по радиусу; затем LOS по стенам)
- Режимы перемещения: свободно и через аппрув DM
- Многоуровневость и спавн
- Сохранение/загрузка локаций (JSON)

## Заметки
- Алиасы TS: `@dnd/shared` указывает на `packages/shared/src/` (dev)
- Граница карты сейчас условная (±50 клеток) и проверяется на сервере
- Для роли DM используйте инвайт, начинающийся с `dm-` (например, `dm-local`)
- Клиент может подключаться к серверу на другом порту: `http://localhost:5173/?inv=dm-local&port=9090` (подставит WS `:9090`).

## Переменные окружения (сервер)
- `PORT` — порт HTTP/WS сервера (по умолчанию `8080`). Пример: `PORT=9090 npm start`.
- `LOCATIONS_DIR` — директория для JSON‑локаций (по умолчанию `packages/server/data/locations`). Пример: `LOCATIONS_DIR=/abs/path npm start`.

## Лицензия
MIT

